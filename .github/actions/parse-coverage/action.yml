name: 'Parse Coverage Report'
description: 'Parse JaCoCo coverage reports and generate summary'
inputs:
  coverage-path:
    description: 'Path pattern for coverage report files'
    required: false
    default: '**/build/reports/jacoco/test/jacocoTestReport.xml'
  min-coverage:
    description: 'Minimum coverage percentage required'
    required: false
    default: '80'
outputs:
  overall-coverage:
    description: 'Overall coverage percentage'
    value: ${{ steps.parse.outputs.overall-coverage }}
  coverage-passed:
    description: 'Whether coverage threshold was met'
    value: ${{ steps.parse.outputs.coverage-passed }}

runs:
  using: 'composite'
  steps:
    - name: Parse coverage reports
      id: parse
      shell: bash
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        TOTAL_COVERED=0
        TOTAL_MISSED=0
        MODULE_COUNT=0
        
        echo "| Module | Coverage |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
        
        # JaCoCo XML ë¦¬í¬íŠ¸ì—ì„œ ì»¤ë²„ë¦¬ì§€ ì •ë³´ ì¶”ì¶œ
        for file in $(find . -path "${{ inputs.coverage-path }}" -type f); do
          if [ -f "$file" ]; then
            MODULE=$(echo "$file" | sed 's|.*/\([^/]*\)/build/.*|\1|')
            
            # ë§ˆì§€ë§‰ INSTRUCTION counterê°€ ì „ì²´ ìš”ì•½ ì •ë³´
            INSTRUCTION_COVERED=$(grep -o '<counter type="INSTRUCTION"[^>]*covered="[0-9]*"' "$file" | grep -o 'covered="[0-9]*"' | grep -o '[0-9]*' | tail -1 || echo "0")
            INSTRUCTION_MISSED=$(grep -o '<counter type="INSTRUCTION"[^>]*missed="[0-9]*"' "$file" | grep -o 'missed="[0-9]*"' | grep -o '[0-9]*' | tail -1 || echo "0")
            
            if [ $((INSTRUCTION_COVERED + INSTRUCTION_MISSED)) -gt 0 ]; then
              COVERAGE=$(((INSTRUCTION_COVERED * 100) / (INSTRUCTION_COVERED + INSTRUCTION_MISSED)))
              
              # ì»¤ë²„ë¦¬ì§€ ìƒíƒœ ì•„ì´ì½˜
              if [ $COVERAGE -ge ${{ inputs.min-coverage }} ]; then
                STATUS="âœ…"
              else
                STATUS="âŒ"
              fi
              
              echo "| $STATUS $MODULE | ${COVERAGE}% (${INSTRUCTION_COVERED}/${INSTRUCTION_COVERED}+${INSTRUCTION_MISSED}) |" >> $GITHUB_STEP_SUMMARY
              
              TOTAL_COVERED=$((TOTAL_COVERED + INSTRUCTION_COVERED))
              TOTAL_MISSED=$((TOTAL_MISSED + INSTRUCTION_MISSED))
              MODULE_COUNT=$((MODULE_COUNT + 1))
            fi
          fi
        done
        
        # ì „ì²´ ì»¤ë²„ë¦¬ì§€ ê³„ì‚°
        if [ $((TOTAL_COVERED + TOTAL_MISSED)) -gt 0 ]; then
          OVERALL_COVERAGE=$(((TOTAL_COVERED * 100) / (TOTAL_COVERED + TOTAL_MISSED)))
        else
          OVERALL_COVERAGE=0
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ Overall Coverage: ${OVERALL_COVERAGE}%" >> $GITHUB_STEP_SUMMARY
        
        if [ $OVERALL_COVERAGE -ge ${{ inputs.min-coverage }} ]; then
          echo "âœ… Coverage threshold met (â‰¥${{ inputs.min-coverage }}%)" >> $GITHUB_STEP_SUMMARY
          echo "coverage-passed=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Coverage below threshold (<${{ inputs.min-coverage }}%)" >> $GITHUB_STEP_SUMMARY
          echo "coverage-passed=false" >> $GITHUB_OUTPUT
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ì»¤ë²„ë¦¬ì§€ ì„¸ë¶€ ë‚´ìš©ì€ ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
        
        # ì¶œë ¥ ì„¤ì •
        echo "overall-coverage=$OVERALL_COVERAGE" >> $GITHUB_OUTPUT